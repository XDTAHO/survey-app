<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>æ»¿æ„åº¦èª¿æŸ¥</title>
  <style>
    /* æ¨£å¼ä¿æŒä¸è®Š */
    :root { --primary: #00BCD4; --primary-dark: #008ba3; --bg: #f0f4f8; --card: #ffffff; --text: #333; --border: #e0e0e0; --emoji-size: 2.2rem; }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg); margin: 0; padding: 20px 0; color: var(--text); }
    .container { max-width: 600px; margin: 0 auto; background: var(--card); min-height: 95vh; box-shadow: 0 4px 20px rgba(0,0,0,0.08); display: flex; flex-direction: column; border-radius: 12px; overflow: hidden; position: relative; }
    .loading-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 999; transition: opacity 0.3s; }
    .loading-overlay.hidden { opacity: 0; pointer-events: none; }
    .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .error-view { text-align: center; padding: 40px; color: #d32f2f; display: none; }
    
    .header { background: var(--primary); color: white; padding: 20px 25px; display: flex; flex-direction: column; gap: 15px; }
    .header h1 { margin: 0; font-size: 1.6rem; font-weight: 600; line-height: 1.3; }
    .header p { margin: 8px 0 0; opacity: 0.9; font-size: 0.95rem; }
    
    .lang-switch { align-self: flex-end; display: flex; flex-wrap: wrap; gap: 6px; justify-content: flex-end; width: 100%; }
    .lang-btn { background: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255, 255, 255, 0.3); color: white; font-size: 0.85rem; cursor: pointer; padding: 6px 12px; border-radius: 20px; transition: all 0.2s; white-space: nowrap; }
    .lang-btn:hover { background: rgba(255, 255, 255, 0.4); }
    .lang-btn.active { background: white; color: var(--primary); font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-color: white; }

    .view { display: none; padding: 25px; flex: 1; animation: fadeIn 0.3s ease forwards; }
    .view.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    .form-group { margin-bottom: 25px; }
    label { display: block; margin-bottom: 10px; font-weight: 600; color: #444; font-size: 1rem; }
    input[type="text"], textarea { width: 100%; padding: 12px 15px; border: 1px solid var(--border); border-radius: 8px; font-size: 16px; background: #fafafa; transition: 0.2s; }
    input:focus, textarea:focus { border-color: var(--primary); background: #fff; outline: none; }
    .options-grid { display: flex; flex-wrap: wrap; gap: 10px; }
    .option-btn { flex: 1 1 calc(33% - 10px); min-width: 100px; padding: 12px 10px; background: white; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; color: var(--text); cursor: pointer; transition: all 0.2s; text-align: center; display: flex; align-items: center; justify-content: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .option-btn:hover { border-color: var(--primary); color: var(--primary); background: #f0fbff; }
    .option-btn.selected { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 8px rgba(0, 188, 212, 0.3); font-weight: 600; }
    .scenario-btn { flex: 1 1 calc(50% - 12px); padding: 20px 10px; font-size: 1.1rem; font-weight: 600; border-width: 2px; border-radius: 12px; }
    .other-input-wrapper { margin-top: 10px; display: none; animation: slideDown 0.3s ease; }
    .other-input-wrapper.show { display: block; }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .rating-container { display: grid; gap: 8px; grid-template-columns: repeat(5, 1fr); margin-top: 5px; }
    .rate-opt { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px 0; border-radius: 12px; cursor: pointer; transition: background 0.2s; }
    .emoji { font-size: var(--emoji-size); margin-bottom: 5px; line-height: 1; filter: grayscale(100%); opacity: 0.4; transition: all 0.4s; }
    .label { font-size: 0.75rem; color: #999; text-align: center; }
    .rate-opt.selected .emoji { filter: grayscale(0%); opacity: 1; transform: scale(1.6); }
    .rate-opt.selected .label { color: var(--primary-dark); font-weight: bold; }
    .submit-area { display: flex; gap: 12px; margin-top: 40px; align-items: stretch; }
    textarea.submit-input { flex: 1; min-height: 80px; resize: vertical; }
    .submit-btn { width: 100px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .submit-btn:disabled { background: #ccc; cursor: not-allowed; }
    .nav-btn { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: 600; margin-top: 20px; cursor: pointer; box-shadow: 0 4px 10px rgba(0, 188, 212, 0.2); }
    .btn-secondary { display: block; margin: 20px auto 0; background: transparent; color: #999; border: 1px solid #eee; padding: 8px 20px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; }
    .thank-you { text-align: center; padding: 50px 20px; }
    .check-icon { width: 80px; height: 80px; line-height: 80px; border-radius: 50%; background: #e0f7fa; color: var(--primary); font-size: 3rem; margin: 0 auto 25px; }
    .footer-version { text-align: center; font-size: 0.75rem; color: #ccc; padding: 15px 0 20px; margin-top: auto; }
    @media (max-width: 768px) { .rating-container { grid-template-columns: 1fr 1fr; grid-template-areas: "opt5 opt4" "opt3 opt3" "opt2 opt1"; } .rate-opt[data-val="5"] { grid-area: opt5; } .rate-opt[data-val="4"] { grid-area: opt4; } .rate-opt[data-val="3"] { grid-area: opt3; width: 60%; justify-self: center; } .rate-opt[data-val="2"] { grid-area: opt2; } .rate-opt[data-val="1"] { grid-area: opt1; } }
  </style>
</head>
<body>

  <div class="container">
    <div id="loading-overlay" class="loading-overlay">
      <div class="spinner"></div>
      <p style="margin-top:15px; color:#666; font-size:0.9rem;" data-i18n="è¼‰å…¥å•å·ä¸­...">è¼‰å…¥å•å·ä¸­...</p>
    </div>

    <div id="error-view" class="error-view">
      <h3 data-i18n="ç„¡æ³•è¼‰å…¥å•å·">ç„¡æ³•è¼‰å…¥å•å·</h3>
      <p id="error-msg" data-i18n="è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šå¾Œé‡è©¦">è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šå¾Œé‡è©¦</p>
      <button class="btn-secondary" onclick="window.location.reload()" data-i18n="é‡æ–°æ•´ç†">é‡æ–°æ•´ç†</button>
    </div>

    <div class="header">
      <div id="lang-switch-container" class="lang-switch"></div>
      <h1 id="form-title">...</h1>
      <p id="form-desc"></p>
    </div>

    <div id="step-1" class="view">
      <div id="basic-questions-container"></div>
      <button class="nav-btn" onclick="nextStepFromBasic()" data-i18n="ä¸‹ä¸€æ­¥">ä¸‹ä¸€æ­¥</button>
    </div>

    <div id="step-2" class="view">
      <div class="form-group">
        <label style="text-align:center; font-size:1.2rem; margin-bottom:20px;" data-i18n="è«‹é¸æ“‡æ‚¨çš„é«”é©—æƒ…å¢ƒ">è«‹é¸æ“‡æ‚¨çš„é«”é©—æƒ…å¢ƒ</label>
        <div id="scenario-list" class="options-grid"></div>
      </div>
      <button id="btn-back-to-basic" class="btn-secondary" onclick="goToStep(1)" data-i18n="â† è¿”å›ä¿®æ”¹åŸºæœ¬è³‡æ–™">â† è¿”å›ä¿®æ”¹åŸºæœ¬è³‡æ–™</button>
    </div>

    <div id="step-3" class="view">
      <h3 id="current-scenario-title" style="margin-top:0; color:var(--primary);">æ»¿æ„åº¦èª¿æŸ¥</h3>
      <div id="satisfaction-questions-container"></div>
      <div class="submit-area" id="submit-area">
        <textarea id="open-feedback" class="submit-input" rows="3" placeholder="å…¶ä»–å»ºè­° (é¸å¡«)..." oninput="saveOpenFeedback(this.value)"></textarea>
        <button id="btn-submit" class="submit-btn" onclick="submitForm()" data-i18n="é€å‡º">é€å‡º</button>
      </div>
      <button id="btn-reselect-scenario" class="btn-secondary" onclick="goToStep(2)" data-i18n="é‡é¸æƒ…å¢ƒ">é‡é¸æƒ…å¢ƒ</button>
    </div>

    <div id="step-thankyou" class="view">
      <div class="thank-you">
        <div class="check-icon">âœ“</div>
        <h2 style="margin:0 0 10px;" data-i18n="æäº¤æˆåŠŸ">æäº¤æˆåŠŸ</h2>
        <p id="thank-msg" style="color:#666; margin-bottom:30px;"></p>
        <button class="nav-btn" onclick="resetFormState()" data-i18n="å†å¡«ä¸€ä»½">å†å¡«ä¸€ä»½</button>
      </div>
    </div>

    <div class="footer-version">System v3.4 (Sheet-Driven Lang)</div>

  </div>

  <script>
    // é è¨­æœ€å°å­—å…¸
    let I18N = { "en": { "è¼‰å…¥å•å·ä¸­...": "Loading...", "é€å‡º": "Submit" } };
    let CURRENT_LANG = 'zh-TW';
    let CONFIG = null;
    let LANG_NAMES_MAP = { 'zh-TW': 'ç¹é«”ä¸­æ–‡' }; // é è¨­

    const urlParams = new URLSearchParams(window.location.search);
    const URL_SCENARIO_ID = urlParams.get('id'); 
    const LS_KEY = 'SURVEY_AUTO_SAVE_V1';

    const state = {
      step: 1, basicData: {}, selectedScenario: null, satisfactionData: {},
      openFeedback: "", hasBasic: true, hasMultipleScenarios: true, isUrlForced: false
    };

    window.onload = async function() {
      const savedLang = localStorage.getItem('SURVEY_LANG');
      if (savedLang) CURRENT_LANG = savedLang;

      try {
        const response = await fetch('/api/config');
        if (!response.ok) throw new Error('Network response was not ok');
        const result = await response.json();
        CONFIG = result.data ? result.data : result;

        if (!CONFIG || !CONFIG.scenarios) throw new Error('Invalid Config Data');

        if (CONFIG.i18n) {
          I18N = CONFIG.i18n;
          // [é—œéµ] å¾ API è®€å–èªè¨€é¡¯ç¤ºåç¨±
          if (CONFIG.langNames) LANG_NAMES_MAP = CONFIG.langNames;
          
          renderLanguageButtons();
          setLanguage(CURRENT_LANG);
        } else {
          renderLanguageButtons();
        }

        initApp();
      } catch (err) {
        console.error('Config Load Error:', err);
        document.getElementById('loading-overlay').style.display = 'none';
        document.getElementById('error-view').style.display = 'block';
      }
    };

    function renderLanguageButtons() {
      const container = document.getElementById('lang-switch-container');
      container.innerHTML = ''; 

      // å–å¾—æ‰€æœ‰å¯ç”¨èªè¨€ (åŒ…å« Config å›å‚³çš„å’Œç¹ä¸­)
      const availableLangs = ['zh-TW'];
      if (CONFIG && CONFIG.i18n) {
        Object.keys(CONFIG.i18n).forEach(code => {
          if (!availableLangs.includes(code)) availableLangs.push(code);
        });
      }

      availableLangs.forEach(code => {
        const btn = document.createElement('button');
        btn.className = 'lang-btn';
        if (code === CURRENT_LANG) btn.classList.add('active');
        
        // ä½¿ç”¨å¾ Sheet è®€å›ä¾†çš„é¡¯ç¤ºåç¨±
        btn.innerText = LANG_NAMES_MAP[code] || code; 
        
        btn.onclick = () => setLanguage(code);
        container.appendChild(btn);
      });
    }

    function t(key) {
      if (CURRENT_LANG === 'zh-TW') return key; 
      if (I18N && I18N[CURRENT_LANG] && I18N[CURRENT_LANG][key]) return I18N[CURRENT_LANG][key];
      return key; 
    }

    function setLanguage(lang) {
      CURRENT_LANG = lang;
      localStorage.setItem('SURVEY_LANG', lang);

      // UI: æ›´æ–°æŒ‰éˆ• active ç‹€æ…‹
      const btns = document.getElementById('lang-switch-container').children;
      for (let btn of btns) {
        btn.classList.remove('active');
        // ç°¡å–®åˆ¤å®šï¼šæŒ‰éˆ•çš„ onclick å‡½æ•¸åŒ…å«äº†è©²èªè¨€ä»£ç¢¼
        if (btn.onclick.toString().includes(`'${lang}'`) || btn.onclick.toString().includes(`"${lang}"`)) {
            btn.classList.add('active');
        }
      }

      // UI: æ›´æ–°æ–‡å­—
      document.querySelectorAll('[data-i18n]').forEach(el => {
        el.innerText = t(el.getAttribute('data-i18n'));
      });

      const feedbackInput = document.getElementById('open-feedback');
      if (feedbackInput) feedbackInput.placeholder = t('å…¶ä»–å»ºè­° (é¸å¡«)...');
      
      // å‹•æ…‹æ›´æ–°è¼¸å…¥æ¡† placeholder
      document.querySelectorAll('.other-input-wrapper input').forEach(input => {
         const idParts = input.id.split('-');
         const qIdx = idParts[idParts.length-1];
         // ç°¡æ˜“åˆ¤æ–·ï¼šè‹¥ title é‚„æ²’å­˜ï¼Œå°±æš«ä¸æ›´æ–°ï¼Œé€šå¸¸é€™æœƒåœ¨ renderBasicInfo é‡ç¹ªæ™‚è™•ç†
      });

      if (CONFIG) {
        document.getElementById('form-title').innerText = t(CONFIG.formTitle || 'å•å·ç³»çµ±');
        document.getElementById('form-desc').innerText = CONFIG.formDescription || '';
        document.getElementById('thank-msg').innerText = CONFIG.thankYouMessage || '';

        if(state.step === 1) renderBasicInfo();
        if(state.step === 2) renderScenarios();
        if(state.step === 3 && state.selectedScenario) setupStep3(state.selectedScenario);
      }
    }

    // --- App Logic (initApp, saveState, restoreState, clearState, navigation...) ---
    // (é‚è¼¯èˆ‡ä¹‹å‰ç‰ˆæœ¬ç›¸åŒï¼Œç‚ºç¯€çœç¯‡å¹…çœç•¥ï¼Œè«‹ç¢ºä¿é€™äº›å‡½å¼å­˜åœ¨æ–¼æ‚¨çš„æª”æ¡ˆä¸­)
    function initApp() {
      document.getElementById('form-title').innerText = t(CONFIG.formTitle || 'å•å·ç³»çµ±');
      document.getElementById('form-desc').innerText = CONFIG.formDescription || '';
      document.getElementById('thank-msg').innerText = CONFIG.thankYouMessage || '';
      state.hasBasic = CONFIG.basicQuestions && CONFIG.basicQuestions.length > 0;
      const scenarioKeys = Object.keys(CONFIG.scenarios || {});
      state.hasMultipleScenarios = scenarioKeys.length > 1;
      let matchedName = null;
      if (URL_SCENARIO_ID && CONFIG.scenarioIdMap) matchedName = CONFIG.scenarioIdMap[URL_SCENARIO_ID.toString()];
      if (matchedName && CONFIG.scenarios[matchedName]) { state.selectedScenario = matchedName; state.isUrlForced = true; state.hasMultipleScenarios = false; }
      restoreState();
      if (state.hasBasic) renderBasicInfo();
      if (!state.isUrlForced && state.hasMultipleScenarios) renderScenarios();
      else if (scenarioKeys.length === 1 && !state.selectedScenario) state.selectedScenario = scenarioKeys[0];
      document.getElementById('loading-overlay').classList.add('hidden');
      setTimeout(() => { document.getElementById('loading-overlay').style.display = 'none'; }, 300);
      decideFirstStep();
    }
    function saveState() { try { localStorage.setItem(LS_KEY, JSON.stringify({ basicData: state.basicData, selectedScenario: state.isUrlForced?null:state.selectedScenario, satisfactionData: state.satisfactionData, openFeedback: state.openFeedback })); } catch(e){} }
    function restoreState() { try { const s=JSON.parse(localStorage.getItem(LS_KEY)); if(s){ if(s.basicData) state.basicData={...s.basicData}; if(!state.isUrlForced&&s.selectedScenario&&CONFIG.scenarios[s.selectedScenario]) state.selectedScenario=s.selectedScenario; if(s.satisfactionData) state.satisfactionData={...s.satisfactionData}; if(s.openFeedback) state.openFeedback=s.openFeedback; } } catch(e){localStorage.removeItem(LS_KEY);} }
    function clearState() { localStorage.removeItem(LS_KEY); state.basicData={}; state.satisfactionData={}; state.openFeedback=""; if(!state.isUrlForced) state.selectedScenario=null; }
    function decideFirstStep() { if(state.hasBasic) goToStep(1); else if(state.hasMultipleScenarios && !state.isUrlForced) goToStep(2); else if(state.selectedScenario){ setupStep3(state.selectedScenario); goToStep(3); } else alert('Config Error'); }
    function renderBasicInfo() {
      const c=document.getElementById('basic-questions-container'); c.innerHTML='';
      (CONFIG.basicQuestions||[]).forEach((q,i)=>{
        const d=document.createElement('div'); d.className='form-group';
        let h=`<label>${t(q.title)}</label>`;
        const val=state.basicData[q.title]||'';
        if(q.options&&q.options.length>0){
          h+=`<div class="options-grid" id="basic-grid-${i}">`;
          q.options.forEach(o=>{
             const sel=(val===o||(val&&!q.options.includes(val)&&(o.includes('å…¶ä»–')||o.includes('Other'))))?'selected':'';
             h+=`<div class="option-btn ${sel}" onclick="selectBasicOption(${i},'${o}',this)">${t(o)}</div>`;
          });
          h+=`</div><div id="basic-other-wrapper-${i}" class="other-input-wrapper ${(!q.options.includes(val)&&val)?'show':''}"><input type="text" id="basic-other-input-${i}" placeholder="${t('è«‹è¼¸å…¥')} ${t(q.title)}..." value="${(!q.options.includes(val)&&val)?val:''}" oninput="updateBasicOther(${i},'${q.title}')"></div>`;
        } else { h+=`<input type="text" class="basic-text-input" value="${val}" oninput="updateBasicText('${q.title}',this.value)">`; }
        d.innerHTML=h; c.appendChild(d);
      });
    }
    function selectBasicOption(i,v,el) {
       const t=CONFIG.basicQuestions[i].title; const g=document.getElementById(`basic-grid-${i}`);
       Array.from(g.children).forEach(c=>c.classList.remove('selected')); el.classList.add('selected');
       const other=document.getElementById(`basic-other-wrapper-${i}`);
       if(v.includes('å…¶ä»–')||v.includes('Other')){ other.classList.add('show'); document.getElementById(`basic-other-input-${i}`).focus(); state.basicData[t]=document.getElementById(`basic-other-input-${i}`).value; }
       else { other.classList.remove('show'); state.basicData[t]=v; } saveState();
    }
    function updateBasicOther(i,t){ state.basicData[t]=document.getElementById(`basic-other-input-${i}`).value; saveState(); }
    function updateBasicText(t,v){ state.basicData[t]=v; saveState(); }
    function nextStepFromBasic(){
      const m=[]; (CONFIG.basicQuestions||[]).forEach(q=>{ if(!state.basicData[q.title]) m.push(t(q.title)); });
      if(m.length>0) return alert(`${t('è«‹å¡«å¯«ä»¥ä¸‹æ¬„ä½ï¼š')}\n${m.join(', ')}`);
      if(state.isUrlForced&&state.selectedScenario){ setupStep3(state.selectedScenario); goToStep(3); return; }
      if(state.hasMultipleScenarios) goToStep(2); else if(state.selectedScenario){ setupStep3(state.selectedScenario); goToStep(3); }
    }
    function renderScenarios(){
       const l=document.getElementById('scenario-list'); l.innerHTML='';
       Object.keys(CONFIG.scenarios||{}).forEach(k=>{
         const b=document.createElement('div'); b.className='option-btn scenario-btn '+(state.selectedScenario===k?'selected':'');
         b.innerText=t(k); b.onclick=()=>{state.selectedScenario=k; saveState(); setupStep3(k); goToStep(3);}; l.appendChild(b);
       });
    }
    function setupStep3(n){
       document.getElementById('current-scenario-title').innerText=t('æ»¿æ„åº¦èª¿æŸ¥');
       const c=document.getElementById('satisfaction-questions-container'); c.innerHTML='';
       const qs=(CONFIG.scenarios&&CONFIG.scenarios[n])?CONFIG.scenarios[n].questions:[];
       qs.forEach((q,i)=>{
         const d=document.createElement('div'); d.className='form-group';
         d.innerHTML=`<label>${i+1}. ${t(q)}</label><div class="rating-container" id="rate-group-${i}">${renderEmojiOptions(i)}</div>`;
         c.appendChild(d);
       });
       const oq=(CONFIG.scenarios&&CONFIG.scenarios[n])?CONFIG.scenarios[n].openQuestion:'';
       const inp=document.getElementById('open-feedback'); inp.placeholder=oq?t(oq):t('å…¶ä»–å»ºè­° (é¸å¡«)...'); inp.value=state.openFeedback||'';
    }
    function saveOpenFeedback(v){ state.openFeedback=v; saveState(); }
    function renderEmojiOptions(i){
       const em=[{v:5,c:'ğŸ˜',l:'éå¸¸æ»¿æ„'},{v:4,c:'ğŸ™‚',l:'æ»¿æ„'},{v:3,c:'ğŸ˜',l:'æ™®é€š'},{v:2,c:'ğŸ™',l:'ä¸æ»¿æ„'},{v:1,c:'ğŸ˜ ',l:'éå¸¸ä¸æ»¿'}];
       return em.map(e=>`<div class="rate-opt ${state.satisfactionData[i]===e.v?'selected':''}" onclick="selectRating(${i},${e.v},this)"><div class="emoji">${e.c}</div><div class="label">${t(e.l)}</div></div>`).join('');
    }
    function selectRating(i,v,el){
       const p=document.getElementById(`rate-group-${i}`); Array.from(p.children).forEach(c=>c.classList.remove('selected'));
       el.classList.add('selected'); state.satisfactionData[i]=v; saveState();
    }
    function goToStep(s){
       document.querySelectorAll('.view').forEach(v=>v.classList.remove('active')); document.getElementById('step-'+s).classList.add('active'); state.step=s; window.scrollTo(0,0);
       if(s===2){ const b=document.getElementById('btn-back-to-basic'); if(b) b.style.display=state.hasBasic?'block':'none'; renderScenarios(); }
    }
    async function submitForm(){
       const s=CONFIG.scenarios[state.selectedScenario]; if(!s) return alert(t('å°šæœªé¸æ“‡æƒ…å¢ƒ'));
       if(Object.keys(state.satisfactionData).length<s.questions.length) return alert(t('è«‹å®Œæˆæ‰€æœ‰æ»¿æ„åº¦è©•åˆ†'));
       const b=document.getElementById('btn-submit'); b.disabled=true; b.innerText=t('é€å‡º...');
       const bv=(CONFIG.basicQuestions||[]).map(q=>state.basicData[q.title]||'');
       const sv=[]; for(let i=0;i<s.questions.length;i++) sv.push(state.satisfactionData[i]);
       try{
         const r=await fetch('/api/submit',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({scenario:state.selectedScenario,basicValues:bv,satisfactionValues:sv,openFeedback:state.openFeedback})});
         const res=await r.json(); if(res.success){ clearState(); goToStep('thankyou'); } else throw new Error(res.error);
       }catch(e){ alert(t('é€£ç·šå¤±æ•—: ')+e.message); b.disabled=false; b.innerText=t('é€å‡º'); }
    }
    function resetFormState(){ clearState(); initApp(); const b=document.getElementById('btn-submit'); b.disabled=false; b.innerText=t('é€å‡º'); }
  </script>
</body>
</html>
